---
title: "Visualizing Effect of Data Transformations on Errors"
author: "Robert M Flight & Hunter NB Moseley"
date: "`r Sys.time()`"
commit: "`r substr(git2r::branch_target(git2r::head(git2r::repository())), 1, 8)`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(fakeDataWithError)
library(visualizationQualityControl)
library(cowplot)
library(dplyr)
library(errorTransformation)
save_plot_loc <- "~/Documents/posters/dataTransformationsError/figures/"
```

# Problem & Goal

In many omics analyses, a primary step in the data analysis is the application of a transformation to the data.  Transformations are generally employed to convert proportional error (variance) to additive error, which most statistical methods appropriately handle. However, omics data frequently contain error sources that result in both additive and proportional errors. To our knowledge, there has not been a systematic study on detecting the presence of proportional error in omics data, or the effect of transformations on the error structure.

In this work, we demonstrate a set of three simple graphs which facilitate the detection of proportional and mixed error in omics data when multiple replicates are available. The three graphs illustrate proportional and mixed error in a visually compelling manner that is both straight-forward to recognize and to communicate. The graphs plot the 1) absolute difference in the range, 2) standard deviation and 3) relative standard deviation against the mean signal across replicates. In addition to showing the presence of different types of error, these graphs readily demonstrate the effect of various transformations on the error structure as well.

We have developed a straight-forward set of graphs that effectively summarize major types of error present in high replicate datasets. Using these graphical summaries we find that the log-transform is the most effective method of the common methods employed for removing proportional error.

# Data & Transformations

The data for this analysis consists of 1000 points, with 100 replicates. The 100 replicates are generated from the base data with different types of error, either additive (sd = 0.5), proportional (rsd = 0.1), or a mixture. The data transformations investigated include autoscaling, pareto scaling, log, arcsinh and root** (2nd and 5th). 

```{r setup_data}
set.seed(1234)
n_point <- 1000
n_rep <- 100
offset <- 4
simulated_data <- c(rlnorm(n_point / 2, meanlog = 1, sdlog = 1),
                    runif(n_point / 2, 5, 100))
simulated_data <- simulated_data + offset
```

# Additive

```{r additive_error}
add_sd <- 0.5
add_error <- add_uniform_noise(n_rep, simulated_data, add_sd)
add_error[(add_error < 0)] <- 0

add_nozero <- filter_features(add_error, 1e-16)
add_minone <- filter_features(add_error, 1)
```

# Proportional

```{r prop_error}
prop_sd <- 0.1
prop_error <- add_prop_noise(n_rep, simulated_data, prop_sd)
prop_error[(prop_error < 0)] <- 0

prop_nozero <- filter_features(prop_error, 1e-16)
prop_minone <- filter_features(prop_error, 1)
```

Proportional error was added with a relative standard deviation of `r prop_sd`. A
plot of two replicates is shown in Figure X.

# Mixed Error

```{r mix_error}
mix_error <- add_prop_uniform(n_rep, simulated_data, add_sd, prop_sd)
mix_error[(mix_error < 0)] <- 0

mix_nozero <- filter_features(mix_error, 1e-16)
mix_minone <- filter_features(mix_error, 1)
```


# Pair plots

## Additive

```{r buildup_plots}
pair_frame <- data.frame(rep1 = add_error[,1], rep2 = add_error[,2])
add_pair_plot <- ggplot(pair_frame, aes(x = rep1, y = rep2)) + geom_point()

ma_frame <- data.frame(M = add_error[,1] - add_error[,2],
                      A = rowMeans(add_error[, 1:2]))
add_ma_plot <- ggplot(ma_frame, aes(x = A, y = M)) + geom_point()

diff_error <- apply(add_error, 1, function(x){
  max(x) - min(x)
})
range_frame <- data.frame(difference = diff_error,
                          mean = rowMeans(add_error))
add_diff_plot <- ggplot(range_frame, aes(x = mean, y = difference)) + geom_point()

add_error_summ <- summarize_data(t(add_error))
add_sd_plot <- filter(add_error_summ, type == "sd") %>% 
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("sd")
add_rsd_plot <- filter(add_error_summ, type == "rsd") %>%
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("rsd")

add_pair_plot <- plot_grid(add_pair_plot, add_ma_plot, add_diff_plot, add_sd_plot, add_rsd_plot, nrow = 1,
          labels = LETTERS[1:5])
add_pair_plot
```

```{r save_pair_plot}
ggsave(filename = file.path(save_plot_loc, "add_pair_plot.png"), plot = add_pair_plot, 
       width = 11, height = 5, dpi = 300)
```

## Proportional

```{r buildup_plots}
pair_frame <- data.frame(rep1 = prop_error[,1], rep2 = prop_error[,2])
prop_pair_plot <- ggplot(pair_frame, aes(x = rep1, y = rep2)) + geom_point()

ma_frame <- data.frame(M = prop_error[,1] - prop_error[,2],
                      A = rowMeans(prop_error[, 1:2]))
prop_ma_plot <- ggplot(ma_frame, aes(x = A, y = M)) + geom_point()

diff_error <- apply(prop_error, 1, function(x){
  max(x) - min(x)
})
range_frame <- data.frame(difference = diff_error,
                          mean = rowMeans(prop_error))
prop_diff_plot <- ggplot(range_frame, aes(x = mean, y = difference)) + geom_point()

prop_error_summ <- summarize_data(t(prop_error))
prop_sd_plot <- filter(prop_error_summ, type == "sd") %>% 
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("sd")
prop_rsd_plot <- filter(prop_error_summ, type == "rsd") %>%
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("rsd")

prop_pair_plot <- plot_grid(prop_pair_plot, prop_ma_plot, prop_diff_plot, prop_sd_plot, prop_rsd_plot, nrow = 1,
          labels = LETTERS[1:5])
prop_pair_plot
```

```{r prop_save_pair_plot}
ggsave(filename = file.path(save_plot_loc, "prop_pair_plot.png"), plot = prop_pair_plot, 
       width = 11, height = 5, dpi = 300)
```


## Mixed 

## Proportional

```{r buildup_plots}
pair_frame <- data.frame(rep1 = mix_error[,1], rep2 = mix_error[,2])
mix_pair_plot <- ggplot(pair_frame, aes(x = rep1, y = rep2)) + geom_point()

ma_frame <- data.frame(M = abs(mix_error[,1] - mix_error[,2]),
                      A = rowMeans(mix_error[, 1:2]))
mix_ma_plot <- ggplot(ma_frame, aes(x = A, y = M)) + geom_point()

diff_error <- apply(mix_error, 1, function(x){
  abs(max(x) - min(x))
})
range_frame <- data.frame(difference = diff_error,
                          mean = rowMeans(mix_error))
mix_diff_plot <- ggplot(range_frame, aes(x = mean, y = difference)) + geom_point()

mix_error_summ <- summarize_data(t(mix_error))
mix_sd_plot <- filter(mix_error_summ, type == "sd") %>% 
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("sd")
mix_rsd_plot <- filter(mix_error_summ, type == "rsd") %>%
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("rsd")

mix_pair_plot <- plot_grid(mix_pair_plot, mix_ma_plot, mix_diff_plot, mix_sd_plot, mix_rsd_plot, nrow = 1,
          labels = LETTERS[1:5])
mix_pair_plot
```

```{r mix_save_pair_plot}
ggsave(filename = file.path(save_plot_loc, "mix_pair_plot.png"), plot = mix_pair_plot, 
       width = 11, height = 5, dpi = 300)
```

