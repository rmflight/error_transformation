---
title: "Visualizing Effect of Data Transformations on Errors"
author: "Robert M Flight & Hunter NB Moseley"
date: "`r Sys.time()`"
commit: "`r substr(git2r::branch_target(git2r::head(git2r::repository())), 1, 8)`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(fakeDataWithError)
library(visualizationQualityControl)
library(cowplot)
library(dplyr)
library(errorTransformation)
save_plot_loc <- "~/Documents/posters/dataTransformationsError/figures/"
```

# Problem & Goal

In many omics analyses, a primary step in the data analysis is the application of a transformation to the data.  Transformations are generally employed to convert proportional error (variance) to additive error, which most statistical methods appropriately handle. However, omics data frequently contain error sources that result in both additive and proportional errors. To our knowledge, there has not been a systematic study on detecting the presence of proportional error in omics data, or the effect of transformations on the error structure.

In this work, we demonstrate a set of three simple graphs which facilitate the detection of proportional and mixed error in omics data when multiple replicates are available. The three graphs illustrate proportional and mixed error in a visually compelling manner that is both straight-forward to recognize and to communicate. The graphs plot the 1) absolute difference in the range, 2) standard deviation and 3) relative standard deviation against the mean signal across replicates. In addition to showing the presence of different types of error, these graphs readily demonstrate the effect of various transformations on the error structure as well.

We have developed a straight-forward set of graphs that effectively summarize major types of error present in high replicate datasets. Using these graphical summaries we find that the log-transform is the most effective method of the common methods employed for removing proportional error.

# Data & Transformations

```{r setup_data}
set.seed(1234)
n_point <- 1000
n_rep <- 100
offset <- 4
simulated_data <- c(rlnorm(n_point / 2, meanlog = 1, sdlog = 1),
                    runif(n_point / 2, 5, 100))
simulated_data <- simulated_data + offset
```

Simulated data was generated by drawing points from two different distributions:
1) log-normal distribution with a mean in log-space of 1 and a standard
deviation of 1; 2) a uniform distribution over the range of 5 - 100, with 
`r n_point/2` points in each distribution. A value of `r offset` was added to 
the data purely to avoid values <= 1 following the addition
of error, making visualization easier. These data points are the **pure**
initial data to which different types of error are added. From this set, 
`r n_rep` replicates are generated with either *additive* (`add`), *proportional*
(`prop`) or *mixed* (both additive and proportional, `mixed`) error.

The transformations applied are autoscaling, pareto scaling, log, arcsinh, and
root (2nd and 5th).

# Create Data

## Additive 

```{r additive_error}
add_sd <- 0.5
add_error <- add_uniform_noise(n_rep, simulated_data, add_sd)
add_error[(add_error < 0)] <- 0

add_nozero <- filter_features(add_error, 1e-16)
add_minone <- filter_features(add_error, 1)
```

## Proportional

```{r prop_error}
prop_sd <- 0.1
prop_error <- add_prop_noise(n_rep, simulated_data, prop_sd)
prop_error[(prop_error < 0)] <- 0

prop_nozero <- filter_features(prop_error, 1e-16)
prop_minone <- filter_features(prop_error, 1)
```


## Mixed Error

```{r mix_error}
mix_error <- add_prop_uniform(n_rep, simulated_data, add_sd, prop_sd)
mix_error[(mix_error < 0)] <- 0

mix_nozero <- filter_features(mix_error, 1e-16)
mix_minone <- filter_features(mix_error, 1)
```


# Figures 1 - 3

## Additive Error

Fig 1. Additive error only. A) Two replicates plotted in "original" space B) Same two replicates rotated using MA plot, where M "minus" (rep1 - rep2) and A is average of rep1 and rep2. C) Difference between largest value and smallest value vs the mean E) Standard deviation (sd) across replicates vs the mean F) Relative standard deviation vs the mean. Red line indicates the amount of additive error added.

```{r buildup_plots}
pair_frame <- data.frame(rep1 = add_error[,1], rep2 = add_error[,2])
add_pair_plot <- ggplot(pair_frame, aes(x = rep1, y = rep2)) + geom_point()

ma_frame <- data.frame(M = add_error[,1] - add_error[,2],
                      A = rowMeans(add_error[, 1:2]))
add_ma_plot <- ggplot(ma_frame, aes(x = A, y = M)) + geom_point()

diff_error <- apply(add_error, 1, function(x){
  max(x) - min(x)
})
range_frame <- data.frame(difference = diff_error,
                          mean = rowMeans(add_error))
add_diff_plot <- ggplot(range_frame, aes(x = mean, y = difference)) + geom_point()

add_error_summ <- summarize_data(t(add_error))
add_sd_plot <- filter(add_error_summ, type == "sd") %>% 
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("sd") + geom_hline(yintercept = add_sd, color = "red")
add_rsd_plot <- filter(add_error_summ, type == "rsd") %>%
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("rsd")

add_pair_plot <- plot_grid(add_pair_plot, add_ma_plot, add_diff_plot, add_sd_plot, add_rsd_plot, nrow = 1,
          labels = LETTERS[1:5])
add_pair_plot
```

```{r save_pair_plot}
ggsave(filename = file.path(save_plot_loc, "add_pair_plot.png"), plot = add_pair_plot, 
       width = 20, height = 5, dpi = 300)
```

## Proportional Error

Fig 2. Proportional error only. A) Two replicates plotted in "original" space B) Same two replicates rotated using MA plot, where M "minus" (rep1 - rep2) and A is average of rep1 and rep2. C) Difference between largest value and smallest value vs the mean E) Standard deviation (sd) across replicates vs the mean F) Relative standard deviation vs the mean. Red line indicates the amount of proportional error added.

```{r prop_buildup_plots}
pair_frame <- data.frame(rep1 = prop_error[,1], rep2 = prop_error[,2])
prop_pair_plot <- ggplot(pair_frame, aes(x = rep1, y = rep2)) + geom_point()

ma_frame <- data.frame(M = prop_error[,1] - prop_error[,2],
                      A = rowMeans(prop_error[, 1:2]))
prop_ma_plot <- ggplot(ma_frame, aes(x = A, y = M)) + geom_point()

diff_error <- apply(prop_error, 1, function(x){
  max(x) - min(x)
})
range_frame <- data.frame(difference = diff_error,
                          mean = rowMeans(prop_error))
prop_diff_plot <- ggplot(range_frame, aes(x = mean, y = difference)) + geom_point()

prop_error_summ <- summarize_data(t(prop_error))
prop_sd_plot <- filter(prop_error_summ, type == "sd") %>% 
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("sd")
prop_rsd_plot <- filter(prop_error_summ, type == "rsd") %>%
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("rsd") + geom_hline(yintercept = prop_sd, color = "red")

prop_pair_plot <- plot_grid(prop_pair_plot, prop_ma_plot, prop_diff_plot, prop_sd_plot, prop_rsd_plot, nrow = 1,
          labels = LETTERS[1:5])
prop_pair_plot
```

```{r prop_save_pair_plot}
ggsave(filename = file.path(save_plot_loc, "prop_pair_plot.png"), plot = prop_pair_plot, 
       width = 20, height = 5, dpi = 300)
```


## Mixed Error

Fig 3. Additive and proportional error. A) Two replicates plotted in "original" space B) Same two replicates rotated using MA plot, where M "minus" (rep1 - rep2) and A is average of rep1 and rep2. C) Difference between largest value and smallest value vs the mean E) Standard deviation (sd) across replicates vs the mean F) Relative standard deviation vs the mean.


```{r mix_buildup_plots}
pair_frame <- data.frame(rep1 = mix_error[,1], rep2 = mix_error[,2])
mix_pair_plot <- ggplot(pair_frame, aes(x = rep1, y = rep2)) + geom_point()

ma_frame <- data.frame(M = mix_error[,1] - mix_error[,2],
                      A = rowMeans(mix_error[, 1:2]))
mix_ma_plot <- ggplot(ma_frame, aes(x = A, y = M)) + geom_point()

diff_error <- apply(mix_error, 1, function(x){
  abs(max(x) - min(x))
})
range_frame <- data.frame(difference = diff_error,
                          mean = rowMeans(mix_error))
mix_diff_plot <- ggplot(range_frame, aes(x = mean, y = difference)) + geom_point()

mix_error_summ <- summarize_data(t(mix_error))
mix_sd_plot <- filter(mix_error_summ, type == "sd") %>% 
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("sd")
mix_rsd_plot <- filter(mix_error_summ, type == "rsd") %>%
  ggplot(., aes(x = mean, y = var)) + geom_point() + ylab("rsd")

mix_pair_plot <- plot_grid(mix_pair_plot, mix_ma_plot, mix_diff_plot, mix_sd_plot, mix_rsd_plot, nrow = 1,
          labels = LETTERS[1:5])
mix_pair_plot
```

```{r mix_save_pair_plot}
ggsave(filename = file.path(save_plot_loc, "mix_pair_plot.png"), plot = mix_pair_plot, 
       width = 20, height = 5, dpi = 300)
```

# Results

For each of the transformations, the data were transformed, the data examined using the difference, SD and RSD plots, and in some cases compared to either the untransformed data or another transformation.

## Auto-Scaling

### Additive

```{r auto_additive}
ae_as <- auto_scale(add_error)
ae_as_summary <- summarize_data(t(ae_as))
ae_as_diff <- plot_diff(ae_as, log_mean = log, use_title = NULL)
ae_as_sd <- plot_sd(ae_as, log_mean = log, use_title = NULL)
ae_as_rsd <- plot_sd(ae_as, sd_type = "rsd", log_mean = log, use_title = NULL)
plot_grid(ae_as_diff, ae_as_sd, ae_as_rsd, nrow = 1, labels = LETTERS[1:3])
```

### Proportional

```{r auto_proportional}
pe_as <- auto_scale(prop_error)
pe_as_diff <- plot_diff(pe_as, log_mean = log, use_title = NULL)
pe_as_sd <- plot_sd(pe_as, log_mean = log, use_title = NULL)
pe_as_rsd <- plot_sd(pe_as, sd_type = "rsd", log_mean = log, use_title = NULL)
plot_grid(pe_as_diff, pe_as_sd, pe_as_rsd, nrow = 1, labels = LETTERS[1:3])
```

### Mixed

```{r auto_mixed}
me_as <- auto_scale(mix_error)
me_as_diff <- plot_diff(me_as, log_mean = log, use_title = NULL)
me_as_sd <- plot_sd(me_as, log_mean = log, use_title = NULL)
me_as_rsd <- plot_sd(me_as, sd_type = "rsd", log_mean = log, use_title = NULL)
mix_auto <- plot_grid(me_as_diff, me_as_sd, me_as_rsd, nrow = 1, labels = LETTERS[1:3])
mix_auto
```

```{r autoscale_check}
me_nt_summ <- summarize_data(t(mix_error))
max_me_nt <- filter(me_nt_summ, type == "rsd") %>% select(., var) %>% max()

me_as_summ <- summarize_data(t(me_as))
max_me_as <- filter(me_as_summ, type == "rsd") %>% select(., var) %>% max()
identical(max_me_nt, max_me_as)

auto_compare <- summarize_two(mix_error, me_as, sd_type = "diff", name1 = "mix_error", name2 = "mix_as")
auto_compare$mean <- log(auto_compare$mean)
ggplot(auto_compare, aes(x = var, fill = data)) + geom_density(alpha = 0.5)
ggplot(auto_compare, aes(x = mean, y = var, color = data)) + geom_point(alpha = 0.5)
```

```{r save_plot}
me_as_plot_compare <- ggplot(auto_compare, aes(x = mean, y = var, color = data)) + 
  geom_point(alpha = 0.5) + xlab("log(mean)") + ylab("diff")

mix_auto2 <- plot_grid(me_as_diff, me_as_sd, me_as_rsd, me_as_plot_compare, nrow = 1, labels = LETTERS[1:4])
mix_auto2
```

```{r}
ggsave(file.path(save_plot_loc, "mix_auto.png"), plot = mix_auto2, dpi = 300,
       width = 16, height = 5)
```

Applying a variance or autoscaling to the data results in the removal of the additive error to a completely identical standard deviation of 1 across all samples at all abundances. This applies across all of the different error types. Although the standard deviation becomes identical and constant, the maximum relative variance is the same, and the distribution of the rsd values is identical, while the range of the mean is completely changed, as well as it's relationship to the differences.

## Pareto Scaling

### Additive

```{r pareto_add}
ae_ps <- pareto_scale(add_error)
ae_ps_diff <- plot_diff(ae_ps, log_mean = log, use_title = NULL)
ae_ps_sd <- plot_sd(ae_ps, log_mean = log, use_title = NULL)
ae_ps_rsd <- plot_sd(ae_ps, sd_type = "rsd", log_mean = log, use_title = NULL)
plot_grid(ae_ps_diff, ae_ps_sd, ae_ps_rsd, nrow = 1, labels = LETTERS[1:3])
```

### Proportional

```{r pareto_prop}
pe_ps <- pareto_scale(prop_error)
pe_ps_diff <- plot_diff(pe_ps, log_mean = log, use_title = NULL)
pe_ps_sd <- plot_sd(pe_ps, log_mean = log, use_title = NULL)
pe_ps_rsd <- plot_sd(pe_ps, sd_type = "rsd", log_mean = log, use_title = NULL)
plot_grid(pe_ps_diff, pe_ps_sd, pe_ps_rsd, nrow = 1, labels = LETTERS[1:3])
```

### Mixed

```{r pareto_mixed}
me_ps <- pareto_scale(mix_error)
me_ps_diff <- plot_diff(me_ps, log_mean = log, use_title = NULL)
me_ps_sd <- plot_sd(me_ps, log_mean = log, use_title = NULL)
me_ps_rsd <- plot_sd(me_ps, sd_type = "rsd", log_mean = log, use_title = NULL)
plot_grid(me_ps_diff, me_ps_sd, me_ps_rsd, nrow = 1, labels = LETTERS[1:3])
```

```{r pareto_check_rsd_ranges}
me_ps_summ <- summarize_data(t(me_ps))
max_me_ps <- filter(me_ps_summ, type == "rsd") %>% select(., var) %>% max()
all.equal(max_me_nt, max_me_ps)

pareto_compare <- summarize_two(mix_nozero, me_ps, sd_type = "rsd", name1 = "mix", name2 = "mix_pareto")

pareto_compare$mean <- log(pareto_compare$mean)
ggplot(pareto_compare, aes(x = var, fill = data)) + geom_density(alpha = 0.5)
ggplot(pareto_compare, aes(x = mean, y = var, color = data)) + geom_point(alpha = 0.5)
```

In contrast to autoscaling, pareto scaling modifies the values by the square root of the variance. As shown in Figure X, this changes the absolute values of the standard deviations, but does not change the distribution, or the dependence of variance on the average abundance. In addition, the relative error remains the same, as the maximum values of the rsd in the mixed error case for the pareto scaled and non-transformed data are the same at `r max_me_nt`.

```{r pareto_save_plots}
me_ps_rsd_oomp <- ggplot(pareto_compare, aes(x = mean, y = var, color = data)) + geom_point(alpha = 0.5) + 
  xlab("log(mean)") + ylab("rsd")
pareto_out_graph <- plot_grid(me_ps_diff, me_ps_sd, me_ps_rsd, me_ps_rsd_oomp, nrow = 1, labels = LETTERS[1:4])

pareto_out_graph

ggsave(file.path(save_plot_loc, "mix_pareto.png"), plot = pareto_out_graph, dpi = 300,
       width = 16, height = 5)
```


## Log Transformation

### Additive Error

```{r log_add_error}
log_add <- log(add_error)
ae_lt_diff <- plot_diff(log_add, log_mean = FALSE)
ae_lt_sd <- plot_sd(log_add, log_mean = FALSE)
ae_lt_rsd <- plot_sd(log_add, log_mean = FALSE, sd_type = "rsd")
plot_grid(ae_lt_diff, ae_lt_sd, ae_lt_rsd, nrow = 1, labels = LETTERS[1:3])
```

### Proportional Error

```{r log_prop_error}
log_prop <- log(prop_error)

pe_lt_diff <- plot_diff(log_prop, log_mean = FALSE, use_title = NULL)
pe_lt_sd <- plot_sd(log_prop, log_mean = FALSE, use_title = NULL)
pe_lt_rsd <- plot_sd(log_prop, log_mean = FALSE, sd_type = "rsd", use_title = NULL)
plot_grid(pe_lt_diff, pe_lt_sd, pe_lt_rsd, nrow = 1, labels = LETTERS[1:3])
```

### Mixed Error

```{r log_mix_error}
log_mix <- log(mix_error)

me_lt_diff <- plot_diff(log_mix, log_mean = FALSE, use_title = NULL)
me_lt_sd <- plot_sd(log_mix, log_mean = FALSE, use_title = NULL)
me_lt_rsd <- plot_sd(log_mix, log_mean = FALSE, sd_type = "rsd", use_title = NULL)
plot_grid(me_lt_diff, me_lt_sd, me_lt_rsd, nrow = 1, labels = LETTERS[1:3])
```


### Compare Add Error

```{r check_log_transforms_add}
compare_lt_ae_sr <- rbind(
  summarize_data(t(add_error)) %>% filter(., type == "rsd") %>% mutate(., data = "add") %>% transform(., mean = log(mean)),
  summarize_data(t(log_add)) %>% filter(., type == "sd") %>% mutate(., data = "log"))

hist_compare_lt_ae_sr <- ggplot(compare_lt_ae_sr, aes(x = var, fill = data)) + geom_density(alpha = 0.5)
point_compare_lt_ae_sr <- ggplot(compare_lt_ae_sr, aes(x = mean, y = var, color = data)) + 
  geom_point(alpha = 0.5)

plot_grid(hist_compare_lt_ae_sr, point_compare_lt_ae_sr, nrow = 1, labels = LETTERS[1:2])

compare_lt_ae_rr <- rbind(
  summarize_data(t(add_nozero)) %>% filter(., type == "rsd") %>% mutate(., data = "add") %>% transform(., mean = log(mean)),
  summarize_data(t(log_add)) %>% filter(., type == "rsd") %>% mutate(., data = "log")
)
hist_compare_lt_ae_rr <- ggplot(compare_lt_ae_rr, aes(x = var, fill = data)) + 
  geom_density(alpha = 0.5)
point_compare_lt_ae_rr <- ggplot(compare_lt_ae_rr, aes(x = mean, y = var, color = data)) +
  geom_point(alpha = 0.5)
plot_grid(hist_compare_lt_ae_rr, point_compare_lt_ae_rr, nrow = 1, labels = LETTERS[1:2])
```

Log-transformations completely change the structure of the data. Figure X shows
that for the additive error only case, the SD vs mean looks more like the RSD vs
mean in the non-transformed case.

```{r check_lt_pe}
compare_lt_pe_rs <- rbind(
  summarize_data(t(prop_error)) %>% filter(., type == "rsd") %>% 
    mutate(., data = "prop") %>% transform(., mean = log(mean)),
  summarize_data(t(log_prop)) %>% filter(., type == "sd") %>%
    mutate(., data = "prop_log")
)

hist_comp_lt_pe_rs <- ggplot(compare_lt_pe_rs, aes(x = var, fill = data)) + 
  geom_density(alpha = 0.5)
point_comp_lt_pe_rs <- ggplot(compare_lt_pe_rs, aes(x = mean, y = var, color = data)) +
  geom_point(alpha = 0.5)

plot_grid(hist_comp_lt_pe_rs, point_comp_lt_pe_rs, nrow = 1, labels = LETTERS[1:2])

compare_lt_pe_rr <- rbind(
  summarize_data(t(prop_error)) %>% filter(., type == "rsd") %>% 
    mutate(., data = "prop") %>% transform(., mean = log(mean)),
  summarize_data(t(log_prop)) %>% filter(., type == "rsd") %>%
    mutate(., data = "prop_log")
)

hist_comp_lt_pe_rr <- ggplot(compare_lt_pe_rr, aes(x = var, fill = data)) + 
  geom_density(alpha = 0.5)
point_comp_lt_pe_rr <- ggplot(compare_lt_pe_rr, aes(x = mean, y = var, color = data)) +
  geom_point(alpha = 0.5)
plot_grid(hist_comp_lt_pe_rr, point_comp_lt_pe_rr, nrow = 1, labels = LETTERS[1:2])
```


For the proportional error case, the proportional error has been almost completely
transformed into additive error.

```{r check_lt_me}
compare_lt_me_rs <- rbind(
  summarize_data(t(mix_error)) %>% filter(., type == "rsd") %>%
    mutate(., data = "rsd(mix)") %>% transform(., mean = log(mean)),
  summarize_data(t(log_mix)) %>% filter(., type == "sd") %>%
    mutate(., data = "sd(log(mix))")
)

hist_comp_lt_me_rs <- ggplot(compare_lt_me_rs, aes(x = var, fill = data)) + 
  geom_density(alpha = 0.5) + theme(legend.position = "none")
point_comp_lt_me_rs <- ggplot(compare_lt_me_rs, aes(x = mean, y = var, color = data)) +
  geom_point(alpha = 0.5) + theme(legend.position = c(0.5, 0.8), legend.title = element_text(size = 0))
plot_grid(hist_comp_lt_me_rs, point_comp_lt_me_rs, nrow = 1, labels = LETTERS[1:2])

compare_lt_me_rr <- rbind(
  summarize_data(t(mix_nozero)) %>% filter(., type == "rsd") %>%
    mutate(., data = "mix") %>% transform(., mean = log(mean)),
  summarize_data(t(log_mix)) %>% filter(., type == "rsd") %>%
    mutate(., data = "mix_log")
)

hist_comp_lt_me_rr <- ggplot(compare_lt_me_rr, aes(x = var, fill = data)) + 
  geom_density(alpha = 0.5)
point_comp_lt_me_rr <- ggplot(compare_lt_me_rr, aes(x = mean, y = var, color = data)) +
  geom_point(alpha = 0.5)
plot_grid(hist_comp_lt_me_rr, point_comp_lt_me_rr, nrow = 1, labels = LETTERS[1:2])
```


```{r save_log_mix}
out_log_mix <- plot_grid(me_lt_diff, me_lt_sd, me_lt_rsd, hist_comp_lt_me_rs, 
                         point_comp_lt_me_rs, nrow = 1, labels = LETTERS[1:5])
ggsave(file.path(save_plot_loc, "mix_log.png"), plot = out_log_mix, dpi = 300,
       width = 20, height = 5)
```

