---
title: "Visualizing Effect of Data Transformations on Errors"
author: "Robert M Flight"
date: "`r Sys.time()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(fakeDataWithError)
library(visualizationQualityControl)
library(cowplot)
library(dplyr)
```

```{r function_defs, include=FALSE}
plot_function <- function(org_data, include_orgrep = TRUE, log_mean = TRUE){
  summ_data <- summarize_data(t(org_data))
  
  if (include_orgrep) {
    org_frame <- data.frame(rep1 = org_data[,1], rep2 = org_data[,2])
    org_plot <- ggplot(org_frame, aes(x = rep1, y = rep2)) + geom_point() +
      ggtitle("Rep1 vs Rep2")
  }
  
  use_mean <- "mean"
  x_title <- use_mean
  if (log_mean) {
    #summ_data[(summ_data$mean < 0), "mean"] <- 0
    summ_data <- mutate(summ_data, log_mean = log1p(mean))
    
    use_mean <- "log_mean"
    x_title <- "log(mean)"
  }
  
  sd_plot <- filter(summ_data, type == "sd") %>% 
    ggplot(., aes_string(x = use_mean, y = "var")) + geom_point() +
    ggtitle("Mean vs SD") + xlab(x_title) + ylab("sd")
  rsd_plot <- filter(summ_data, type == "rsd") %>%
    ggplot(., aes_string(x = use_mean, y = "var")) + geom_point() +
    ggtitle("Mean vs RSD") + xlab(x_title) + ylab("rsd")
  
  if (include_orgrep) {
    out_plot <- plot_grid(org_plot, sd_plot, rsd_plot, ncol = 3, nrow = 1,
              labels = c("A", "B", "C"))
  } else {
    out_plot <- plot_grid(sd_plot, rsd_plot, ncol = 2, nrow = 1, labels = c("A", "B"))
  }
  out_plot
}
```


# Introduction

Data transformations are frequently applied to different -omics data to change
properties of the data and make it more amenable to various statistical assumptions.
Included in the types of changes that are made include changing the error structure,
frequently from multiplicative errors that are commonly present in any data
generated by counts at a detector (essentially all -omics data) to additive errors,
which are more easily handled by most statistical methods.

We have previously used a simple summary of replicates consisting of the **mean**,
**standard deviation** (sd), and **relative standard deviation** (rsd) to evaluate
the presence of and type of errors in various -omics datasets. A simple plot of
both the **mean vs sd** and **mean vs rsd** is able to determine whether the
errors in an experiment are primarily **additive** (random, constant, baseline 
error), **proportional** (dependent on the signal value), or a **mixture**.

Previous work has examined the influence of transformations on both the structure
of the data and the errors through the use of replicated nuclear magnetic resonance
(NMR) experiments (REF). Although insightful, the exact types of errors were not
controlled, although they were likely similar to those simulated in this work.
Most of the discussion in previous work also concentrated on the shape of the
spectra after scaling and transformation. However, in many other -omics data
types outside of NMR, there is no real spectra, but simply an aggregation of
values measured on independent features, and therefore changes in shape of the
overall spectra are largely irrelevant. More importantly are whether relative
changes are preserved, and **how** the error structure changes.



# Methods



## Data

Simulated data was generated from an initial set of 10000 points drawn from 
a log-normal distribution with a mean in log-space of 1 and a standard deviation
of 1 (see histogram in Figure X). These data points are the **pure** initial 
data to which different types of error are added. From this set, 100 replicates are 
generated with either *additive*, *proportional* or *mixed* (both additive and
proportional) error. Negative values are truncated to zero, because there cannot
be negative values when measuring the abundance of physical entities, and because
it makes applying log-transforms even more difficult than usual.

```{r setup_data}
set.seed(1234)
n_point <- 10000
n_rep <- 100
simulated_data <- rlnorm(n_point, meanlog = 1, sdlog = 1)
```

```{r pure_histogram}
simulated_frame <- data.frame(abundance = simulated_data)
ggplot(simulated_frame, aes(x = abundance)) + geom_histogram(binwidth = 1) + 
  ggtitle("Pure Data")
```

### Additive Error

```{r add_error}
add_sd <- 2
add_error <- add_uniform_noise(n_rep, simulated_data, add_sd)
add_error[(add_error < 0)] <- 0
```

```{r add_plot}
plot_function(add_error)
```

Additive error was added where the standard deviation was `r add_sd`. A plot
of two replicates is shown in Figure X.

### Proportional Error

```{r prop_error}
prop_sd <- 0.1
prop_error <- add_prop_noise(n_rep, simulated_data, prop_sd)
prop_error[(prop_error < 0)] <- 0
```

```{r prop_plot}
plot_function(prop_error)
```

Proportional error was added where the standard deviation was `r prop_sd`. A plot
of two replicates is shown in Figure X.

### Mixed Error

```{r mix_error}
mix_error <- add_prop_uniform(n_rep, simulated_data, add_sd, prop_sd)
mix_error[(mix_error < 0)] <- 0
```

```{r mix_plot}
plot_function(mix_error)
```

Mixture of additive and proportional error was added with standard deviations
of `r add_sd` and `r prop_sd` respectively.

## Transformations



# Results

## Log Transformation

Applying the 


# Conclusion


# Session Information

```{r session_info}
ses_info <- devtools::session_info()
ses_info$platform
knitr::kable(ses_info$packages, format = "markdown")
```


# Create Markdown

```{r runit, eval=FALSE, include = TRUE}
rmarkdown::render("glbio2016_manuscript.Rmd", clean = FALSE)
```
